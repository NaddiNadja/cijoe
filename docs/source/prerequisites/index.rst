.. _sec-prerequisites:

Prerequisites
=============

**TLDR;** To install and run **cijoe**, the requirements are:

* **initiator**: :python:`Python <>` and :pipx:`pipx <>`
* **target**: ssh-server

For the patient reader, the rest of this section provides details on meeting
these requirements, along with various system setup instructions. The system
setup is divided into **initiator** and **target** requirements.

To refresh your understanding from the :ref:`sec-introduction` section, these
roles are illustrated as follows:

.. figure:: ../_static/cijoe-networked.drawio.png
   :alt: Development Environment
   :align: center

   The "core" agentless functionality of **cijoe**; run commands and tranfer
   files

Initiator
---------

The **initiator** is the system where the **cijoe** command-line tool is
executed, and the **cijoe** scripts are run, requiring :python:`Python <>` along
with the necessary :python:`Python <>` package dependencies. With the adoption
of :pep668:`PEP 668 <>` by Linux distributions, providing a virtual environment
for Python packages is now mandatory rather than a recommended practice.

For command-line utilities, :pipx:`pipx <>` offers a convenient way to install
tools within a :python:`Python <>` virtual environment (venv), ensuring the
correct environment variables are set for CLI endpoints to function properly.
Therefore, the initiator must meet the following requirements:

* :python:`Python <>` >= 3.9
* :pipx:`pipx <>`

It is recommended to install :python:`Python <>` and :pipx:`pipx <>` via
the package manager of the **initiator** system. To ensure that **pipx** is
correctly, then run the following::

  pipx ensurepath

.. note::
  The **initiator** uses a pure-Python (3.6+) implementation of the SSHv2
  protocol (:paramiko:`Paramiko <>`), thus, it does not interfere with your
  existing **SSH** setup and does not rely on system crypto/ssl libraries.

After running this, reload your environment by either logging out completely or
starting a new shell session. With :python:`Python <>` and :pipx:`pipx <>` in
place, then install **cijoe**::

  pipx install cijoe --include-deps

Check that it installed correctly, by invoking the **cijoe** command-line tool:



Target
------

**cijoe** is agentless seeks to be minimally intrusive on the **target** system,
**thus, you do not** need to install **anything at all**. However, **cijoe**
**operates under the assumption that:

* You can access the **target** system from the **initiator** via **SSH**

Thus, you do not need to install **anything at all** on
the **target** system for **cijoe**.
However, . system is available via SSH**. Thus, the
**following is recommended:

* ssh-server
* scp
* The **commands** that you want to run

  - Allow root login with password

* A **SSH** key-pair

  * The default filenames for a key-pair generated by ``ssh-keygen`` are
    private key (``id_rsa``) and the public-key (``id_rsa.pub``).

* An **SSH** client, and **key-based** **authorization** providing unprompted
  login from your **dev box** into your **test-target**.

Check that you have the required versions by running the following on your
**dev box**:

.. code-block:: bash

  python3 --version
  pip3 --version

On the **remote end** / **test-target(s)** you need:

* An **account** to log into
* A running **SSH** server

  * Providing remote login using your **account** from your **dev box**

* The **SSH** server configured to allow **key-based** **authorization** for
  your **account** and keys setup to provide unprompted login

**cijoe** relies on **SSH** in order to use a remote **test-target**. To assist
with the **SSH** setup then :ref:`sec-ssh` provides a setup guide for
unprompted login and verifying that the setup is ready to use with **cijoe**.

.. note:: **cjioe** can run "locally", that is, your **dev box** and
   **test-target** is the same machine. However, since most system
   development involves fiddling with the OS kernel, drivers, running
   destructive tests, and in general affect the **test-target** in ways
   that cause system panics and data-loss then the default assumption is that
   the **test-target** is another box accessible remotely via **SSH**.

.. _sec-ssh:

SSH Setup (required)
--------------------

**cijoe** uses ``SSH`` to run commands remotely. This section provides a couple
of setup notes which makes it a pleasant experience. Start with setting up
:ref:`sec-ssh-login`, without it then each command executed will prompt you for
login which is counter-productive. In case you need to execute commands as
``root`` on your **test-target** then you need to change your SSH daemon
configuration, see :ref:`sec-ssh-root` for that.

Lastly, if you want to have remote access to your **test-target** file-system,
then :ref:`sec-ssh-sshfs` provides an easy way of doing that using the ``SSH``
setup. You can of course also use it the other way around, e.g. have your
**test-target** mount your **dev box**.

.. note:: The setup instructions provided here is primarily aimed at
   Linux/FreeBSD/MacOSX like systems. For an equivalent setup-guide and
   description of using OpenSSH client/server on Windows then see `Microsoft
   Docs - OpenSSH in Windows
   <https://docs.microsoft.com/en-us/windows-server/administration/openssh/openssh_overview>`_.

.. _sec-ssh-login:

Unprompted Login
~~~~~~~~~~~~~~~~

Here is what we will do:

* Generate a ``SSH`` key-pair (private and public keys)
* Add the private-key to your SSH-agent
* Deploy the public-key to the target
* Create a target configuration
* Check the target configuration

Generate a Key-Pair
~~~~~~~~~~~~~~~~~~~

Run::

  ssh-keygen -P "" -f $HOME/.ssh/cijoe.key

This will produce the following key-pair::

  cijoe.key       # This is your private key
  cijoe.key.pub   # This is your public

Located in ``$HOME/.ssh/``.

SSH Agent
~~~~~~~~~

Add the key to the ssh-agent::

  ssh-add $HOME/.ssh/cijoe.key

Using an SSH-agent is convenient for keys that have passphrases, as you only
have to provide the passphrase once, when you add the key to the agent, instead
of each time they key is utilized.

Deploy the public-key
~~~~~~~~~~~~~~~~~~~~~

Deploy the public-key to remote host ``hostname``::

  ssh-copy-id -i $HOME/.ssh/cijoe.key.pub hostname

This is the last time you will be prompted for login information when
connecting to ``hostname`` as your user.

.. _sec-ssh-root:

SSH as root
~~~~~~~~~~~

The default configuration of ``sshd`` does **not** permit login using the
``root`` user. Thus, in case you need to **ssh** into the remote target using
``root`` then you need to change the ``ssh`` daemon configuration.

On the target, edit: ``/etc/ssh/sshd_config``, changing the ``PermitRootLogin``
option to::

  PermitRootLogin yes

Then reload the ``ssh`` daemon::

  sudo service ssh restart

It should now be ready for running ``ssh-copy-id`` as described above.

.. _sec-ssh-sshfs:

sshfs (optional)
----------------

The Secure-SHell File-System is a libfuse-based user space file-system which
provides a very easy way to mount a remote file-system via SSH. Install it
using your package-manager, e.g.::

  # Install sshfs
  sudo apt install sshfs

  # Change fuse-configuration; enable user_allow_other
  echo 'user_allow_other' | sudo tee -a /etc/fuse.conf

  # Create a directory for mountpoints
  mkdir $HOME/sshfs

For the specific host that you have deployed keys to, create a mountpoint::

  mkdir $HOME/sshfs/testbox

Mount it using::

  sudo sshfs \
    -o allow_other,default_permissions,IdentityFile=$HOME/.ssh/cijoe.key \
    user@hostname:/ $HOME/sshfs/testbox

And unmount using::

  sudo umount $HOME/sshfs/testbox

.. _SshKeys: https://www.digitalocean.com/community/tutorials/how-to-configure-ssh-key-based-authentication-on-a-linux-server

.. _Bash: https://www.gnu.org/software/bash/
.. _Python 3: https://www.python.org/
